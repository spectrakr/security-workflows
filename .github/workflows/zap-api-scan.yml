# =============================================================================
# ZAP API Scan - ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ì›Œí¬í”Œë¡œìš°
# =============================================================================
# ëª©ì : REST/GraphQL API ì „ìš© ë³´ì•ˆ ìŠ¤ìº”
# ì†Œìš”ì‹œê°„: 10-15ë¶„
# 
# íŠ¹ì§•:
#   - OpenAPI/Swagger ìŠ¤í™ ì§€ì›
#   - API ì—”ë“œí¬ì¸íŠ¸ ìë™ íƒì§€
# =============================================================================

name: Reusable ZAP API Scan

on:
  workflow_call:
    inputs:
      force_run:
        required: false
        type: boolean
        default: false
        description: 'í† í”½ ì—†ì´ ê°•ì œ ì‹¤í–‰'
      
      target_url:
        required: true
        type: string
        description: 'API Base URL (ì˜ˆ: http://localhost:8080/api)'
      
      app_start_command:
        required: true
        type: string
        description: 'ì•± ì‹œì‘ ëª…ë ¹ì–´'
      
      app_port:
        required: false
        type: string
        default: '3000'
        description: 'ì•± í¬íŠ¸'
      
      api_spec_url:
        required: false
        type: string
        default: ''
        description: 'OpenAPI/Swagger ìŠ¤í™ URL (ì„ íƒ, ê¶Œì¥)'
      
      api_format:
        required: false
        type: string
        default: 'openapi'
        description: 'API í˜•ì‹ (openapi, graphql)'

jobs:
  # ---------------------------------------------------------------------------
  # Job 1: í† í”½ í™•ì¸ ë˜ëŠ” ê°•ì œ ì‹¤í–‰
  # ---------------------------------------------------------------------------
  check-topic:
    name: Check Topic or Force Run
    runs-on: self-hosted
    outputs:
      enabled: ${{ steps.check.outputs.enabled }}
    
    steps:
      - name: Check for auto-zap-api topic or force_run
        id: check
        uses: actions/github-script@v6
        with:
          script: |
            // force_runì´ trueë©´ ë¬´ì¡°ê±´ ì‹¤í–‰
            if (${{ inputs.force_run }}) {
              core.setOutput('enabled', 'true');
              console.log('âœ… ZAP API scan enabled (force_run = true)');
              console.log('ğŸ’¡ Running without topic check');
              return;
            }
            
            // í† í”½ í™•ì¸
            const repo = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            const topics = repo.data.topics || [];
            
            if (topics.includes('auto-zap-api')) {
              core.setOutput('enabled', 'true');
              console.log('âœ… ZAP API scan enabled (auto-zap-api topic found)');
            } else {
              core.setOutput('enabled', 'false');
              console.log('â­ï¸ ZAP API scan disabled (no auto-zap-api topic)');
              console.log('ğŸ’¡ Tip: Add topic with "gh repo edit --add-topic auto-zap-api"');
            }

  # ---------------------------------------------------------------------------
  # Job 2: ZAP API ìŠ¤ìº” ì‹¤í–‰
  # ---------------------------------------------------------------------------
  zap-api:
    name: Run ZAP API Scan
    needs: check-topic
    if: needs.check-topic.outputs.enabled == 'true'
    runs-on: self-hosted
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘
      - name: Start application
        run: |
          echo "ğŸš€ Starting application..."
          
          ${{ inputs.app_start_command }} &
          APP_PID=$!
          echo "APP_PID=$APP_PID" >> $GITHUB_ENV
          
          echo "â³ Waiting for app..."
          for i in {1..30}; do
            if curl -s http://localhost:${{ inputs.app_port }}/health > /dev/null 2>&1 || \
               curl -s http://localhost:${{ inputs.app_port }} > /dev/null 2>&1; then
              echo "âœ… App ready!"
              break
            fi
            sleep 2
          done
      
      # API ìŠ¤í™ í™•ì¸ (ìˆëŠ” ê²½ìš°)
      - name: Check API spec
        if: inputs.api_spec_url != ''
        run: |
          echo "ğŸ“„ Checking API spec at ${{ inputs.api_spec_url }}"
          curl -f ${{ inputs.api_spec_url }} > api-spec.json || \
          curl -f ${{ inputs.api_spec_url }} > api-spec.yaml || \
          echo "âš ï¸ Could not download API spec, will proceed without it"
      
      # ZAP Docker ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
      - name: Pull ZAP Docker image
        run: docker pull ghcr.io/zaproxy/zaproxy:stable
      
      # ZAP API ìŠ¤ìº” ì‹¤í–‰ (ìŠ¤í™ ìˆì„ ë•Œ)
      - name: Run ZAP API Scan (with spec)
        if: inputs.api_spec_url != ''
        run: |
          echo "ğŸ” Running ZAP API Scan with spec..."
          echo "Target: ${{ inputs.target_url }}"
          echo "Spec: ${{ inputs.api_spec_url }}"
          
          # API ìŠ¤í™ ë‹¤ìš´ë¡œë“œ
          curl -f ${{ inputs.api_spec_url }} -o /tmp/api-spec.json 2>/dev/null || \
          curl -f ${{ inputs.api_spec_url }} -o /tmp/api-spec.yaml 2>/dev/null || true
          
          docker run --rm \
            --user root \
            --network host \
            -v ${{ github.workspace }}:/zap/wrk:rw \
            -v /tmp:/tmp:rw \
            -t ghcr.io/zaproxy/zaproxy:stable \
            zap-api-scan.py \
            -t ${{ inputs.target_url }} \
            -f ${{ inputs.api_format }} \
            -r report_html.html \
            -w report_md.md \
            -J report_json.json || true
          
          echo "âœ… Scan completed"
        continue-on-error: true
      
      # ZAP API ìŠ¤ìº” ì‹¤í–‰ (ìŠ¤í™ ì—†ì„ ë•Œ)
      - name: Run ZAP API Scan (without spec)
        if: inputs.api_spec_url == ''
        run: |
          echo "ğŸ” Running ZAP API Scan without spec..."
          echo "âš ï¸ Note: Without API spec, some endpoints may be missed"
          echo "Target: ${{ inputs.target_url }}"
          
          docker run --rm \
            --network host \
            -v ${{ github.workspace }}:/zap/wrk:rw \
            -t ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
            -t ${{ inputs.target_url }} \
            -r report_html.html \
            -w report_md.md \
            -J report_json.json || true
          
          echo "âœ… Scan completed"
        continue-on-error: true
      
      # ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-api-report-${{ github.run_number }}
          path: |
            report_html.html
            report_md.md
            report_json.json
          retention-days: 7
      
      # ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ
      - name: Stop application
        if: always()
        run: |
          if [ ! -z "${{ env.APP_PID }}" ]; then
            kill ${{ env.APP_PID }} 2>/dev/null || true
          fi
      
      # ìŠ¤ìº” ìš”ì•½
      - name: Summary
        if: always()
        run: |
          echo "=========================================="
          echo "ZAP API Scan Summary"
          echo "=========================================="
          echo "Target: ${{ inputs.target_url }}"
          if [ ! -z "${{ inputs.api_spec_url }}" ]; then
            echo "API Spec: ${{ inputs.api_spec_url }}"
          else
            echo "API Spec: Not provided"
          fi
          echo "Format: ${{ inputs.api_format }}"
          echo "=========================================="
          echo ""
          echo "ğŸ“Š Download report: Actions â†’ Artifacts"

# =============================================================================
# ì‚¬ìš© íŒ:
# OpenAPI/Swagger ìŠ¤í™ ì œê³µ ê¶Œì¥:
#   - ë” ì •í™•í•œ ìŠ¤ìº”
#   - ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ ìë™ ë°œê²¬
# =============================================================================
