# =============================================================================
# ZAP API Scan - ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ì›Œí¬í”Œë¡œìš°
# =============================================================================
# ëª©ì : REST/GraphQL API ì „ìš© ë³´ì•ˆ ìŠ¤ìº”
# ì†Œìš”ì‹œê°„: 10-15ë¶„
# 
# íŠ¹ì§•:
#   - OpenAPI/Swagger ìŠ¤í™ ì§€ì›
#   - API ì—”ë“œí¬ì¸íŠ¸ ìë™ íƒì§€
#   - REST API ë° GraphQL ëª¨ë‘ ì§€ì›
# 
# í™œì„±í™” ë°©ë²•:
#   gh repo edit YOUR-ORG/YOUR-REPO --add-topic auto-zap-api
# 
# ì‚¬ìš© ì˜ˆì‹œ:
#   jobs:
#     zap-api:
#       uses: spectrakr/security-workflows/.github/workflows/zap-api-scan.yml@main
#       with:
#         target_url: 'http://localhost:8080/api'
#         app_start_command: 'npm install && npm start'
#         app_port: '8080'
#         api_spec_url: 'http://localhost:8080/api-docs/swagger.json'
#         api_format: 'openapi'
# =============================================================================

name: Reusable ZAP API Scan

on:
  workflow_call:
    inputs:
      # API Base URL
      target_url:
        required: true
        type: string
        description: 'API Base URL (ì˜ˆ: http://localhost:8080/api)'
      
      # ì•± ì‹œì‘ ëª…ë ¹ì–´
      app_start_command:
        required: true
        type: string
        description: 'ì•± ì‹œì‘ ëª…ë ¹ì–´'
      
      # ì•± ì‹¤í–‰ í¬íŠ¸
      app_port:
        required: false
        type: string
        default: '3000'
        description: 'ì•± í¬íŠ¸'
      
      # API ìŠ¤í™ URL (ì„ íƒ)
      api_spec_url:
        required: false
        type: string
        default: ''
        description: 'OpenAPI/Swagger ìŠ¤í™ URL (ì„ íƒ, ê¶Œì¥)'
      
      # API ìŠ¤í™ í˜•ì‹
      api_format:
        required: false
        type: string
        default: 'openapi'
        description: 'API í˜•ì‹ (openapi, graphql)'

jobs:
  # ---------------------------------------------------------------------------
  # Job 1: í† í”½ í™•ì¸ - auto-zap-api í† í”½ì´ ìˆëŠ”ì§€ ì²´í¬
  # ---------------------------------------------------------------------------
  check-topic:
    name: Check Topic
    runs-on: ubuntu-latest
    outputs:
      enabled: ${{ steps.check.outputs.enabled }}
    
    steps:
      - name: Check for auto-zap-api topic
        id: check
        uses: actions/github-script@v6
        with:
          script: |
            const repo = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            const topics = repo.data.topics || [];
            if (topics.includes('auto-zap-api')) {
              core.setOutput('enabled', 'true');
              console.log('âœ… ZAP API scan enabled');
            } else {
              core.setOutput('enabled', 'false');
              console.log('â­ï¸ ZAP API scan disabled (no auto-zap-api topic)');
            }

  # ---------------------------------------------------------------------------
  # Job 2: ZAP API ìŠ¤ìº” ì‹¤í–‰
  # ---------------------------------------------------------------------------
  zap-api:
    name: Run ZAP API Scan
    needs: check-topic
    if: needs.check-topic.outputs.enabled == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘
      - name: Start application
        run: |
          echo "ğŸš€ Starting application..."
          
          ${{ inputs.app_start_command }} &
          APP_PID=$!
          echo "APP_PID=$APP_PID" >> $GITHUB_ENV
          
          echo "â³ Waiting for app..."
          for i in {1..30}; do
            if curl -s http://localhost:${{ inputs.app_port }}/health > /dev/null 2>&1 || \
               curl -s http://localhost:${{ inputs.app_port }} > /dev/null 2>&1; then
              echo "âœ… App ready!"
              break
            fi
            sleep 2
          done
      
      # API ìŠ¤í™ í™•ì¸ (ìˆëŠ” ê²½ìš°)
      - name: Check API spec
        if: inputs.api_spec_url != ''
        run: |
          echo "ğŸ“„ Checking API spec at ${{ inputs.api_spec_url }}"
          curl -f ${{ inputs.api_spec_url }} > api-spec.json || \
          curl -f ${{ inputs.api_spec_url }} > api-spec.yaml || \
          echo "âš ï¸ Could not download API spec, will proceed without it"
      
      # ZAP Docker ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
      - name: Pull ZAP Docker image
        run: docker pull ghcr.io/zaproxy/zaproxy:stable
      
      # ZAP API ìŠ¤ìº” ì‹¤í–‰ (ìŠ¤í™ ìˆì„ ë•Œ)
      - name: Run ZAP API Scan (with spec)
        if: inputs.api_spec_url != ''
        run: |
          echo "ğŸ” Running ZAP API Scan with spec..."
          
          # API ìŠ¤í™ ë‹¤ìš´ë¡œë“œ
          curl -f ${{ inputs.api_spec_url }} -o /tmp/api-spec.json 2>/dev/null || \
          curl -f ${{ inputs.api_spec_url }} -o /tmp/api-spec.yaml 2>/dev/null || true
          
          docker run --rm \
            --user root \
            --network host \
            -v ${{ github.workspace }}:/zap/wrk:rw \
            -v /tmp:/tmp:rw \
            -t ghcr.io/zaproxy/zaproxy:stable \
            zap-api-scan.py \
            -t ${{ inputs.target_url }} \
            -f ${{ inputs.api_format }} \
            -r report_html.html \
            -w report_md.md \
            -J report_json.json || true
          
          echo "âœ… Scan completed"
        continue-on-error: true
      
      # ZAP API ìŠ¤ìº” ì‹¤í–‰ (ìŠ¤í™ ì—†ì„ ë•Œ - Baselineìœ¼ë¡œ ëŒ€ì²´)
      - name: Run ZAP API Scan (without spec)
        if: inputs.api_spec_url == ''
        run: |
          echo "ğŸ” Running ZAP API Scan without spec..."
          echo "âš ï¸ Note: Without API spec, some endpoints may be missed"
          
          # ìŠ¤í™ ì—†ì´ Baseline ìŠ¤ìº” ìˆ˜í–‰
          docker run --rm \
            --network host \
            -v ${{ github.workspace }}:/zap/wrk:rw \
            -t ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
            -t ${{ inputs.target_url }} \
            -r report_html.html \
            -w report_md.md \
            -J report_json.json || true
          
          echo "âœ… Scan completed"
        continue-on-error: true
      
      # ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-api-report
          path: |
            report_html.html
            report_md.md
            report_json.json
          retention-days: 30
      
      # ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ
      - name: Stop application
        if: always()
        run: |
          if [ ! -z "${{ env.APP_PID }}" ]; then
            kill ${{ env.APP_PID }} 2>/dev/null || true
          fi
      
      # ìŠ¤ìº” ìš”ì•½
      - name: Summary
        if: always()
        run: |
          echo "=========================================="
          echo "ZAP API Scan Summary"
          echo "=========================================="
          echo "Target: ${{ inputs.target_url }}"
          if [ ! -z "${{ inputs.api_spec_url }}" ]; then
            echo "API Spec: ${{ inputs.api_spec_url }}"
          else
            echo "API Spec: Not provided"
          fi
          echo "Format: ${{ inputs.api_format }}"
          echo "=========================================="

# =============================================================================
# ì‚¬ìš© íŒ:
# 
# OpenAPI/Swagger ìŠ¤í™ ì œê³µ ê¶Œì¥:
#   - ë” ì •í™•í•œ ìŠ¤ìº” (ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ ìë™ ë°œê²¬)
#   - íŒŒë¼ë¯¸í„° íƒ€ì… ìë™ ì¸ì‹
#   - ë” ì ì€ False Positive
# 
# API ìŠ¤í™ URL ì˜ˆì‹œ:
#   - http://localhost:8080/api-docs/swagger.json
#   - http://localhost:8080/openapi.json
#   - http://localhost:8080/v3/api-docs
#   - http://localhost:8080/graphql/schema
# 
# ìŠ¤í™ ì—†ì´ ìŠ¤ìº”:
#   - ê°€ëŠ¥í•˜ì§€ë§Œ ì¼ë¶€ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ë†“ì¹  ìˆ˜ ìˆìŒ
#   - Baseline ìŠ¤ìº”ìœ¼ë¡œ ëŒ€ì²´ë¨
# =============================================================================
