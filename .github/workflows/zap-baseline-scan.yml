# .github/workflows/zap-baseline-scan.yml
# OWASP ZAP Baseline Scan - ìˆ˜ë™ì  ìŠ¤ìº” (ì•ˆì „, ë¹ ë¦„)
# í† í”½ "auto-zap-baseline"ì´ ìˆëŠ” ì €ì¥ì†Œì—ë§Œ ì‹¤í–‰ë¨

name: Reusable ZAP Baseline Scan

on:
  workflow_call:
    inputs:
      target_url:
        description: 'Target URL to scan (e.g., http://localhost:3000)'
        required: true
        type: string
      app_start_command:
        description: 'Command to start the app (e.g., npm start, docker-compose up)'
        required: true
        type: string
      app_port:
        description: 'Port where app runs (default: 3000)'
        required: false
        type: string
        default: '3000'
      rules_file:
        description: 'Custom ZAP rules file path (optional)'
        required: false
        type: string
        default: ''

jobs:
  # 1ë‹¨ê³„: auto-zap-baseline í† í”½ í™•ì¸
  check-topic:
    runs-on: ubuntu-latest
    outputs:
      enabled: ${{ steps.check.outputs.enabled }}
    
    steps:
      - name: Check for auto-zap-baseline topic
        id: check
        uses: actions/github-script@v6
        with:
          script: |
            const repo = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            const topics = repo.data.topics || [];
            
            if (topics.includes('auto-zap-baseline')) {
              core.setOutput('enabled', 'true');
              console.log('âœ… ZAP Baseline scan enabled (auto-zap-baseline topic found)');
            } else {
              core.setOutput('enabled', 'false');
              console.log('â­ï¸ ZAP Baseline scan disabled (no auto-zap-baseline topic)');
            }

  # 2ë‹¨ê³„: ZAP Baseline ìŠ¤ìº” ì‹¤í–‰ (í† í”½ ìˆì„ ë•Œë§Œ)
  zap-baseline:
    needs: check-topic
    if: needs.check-topic.outputs.enabled == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      # ì•± ì‹¤í–‰ (ë°±ê·¸ë¼ìš´ë“œ)
      - name: Start application
        run: |
          echo "Starting application with: ${{ inputs.app_start_command }}"
          ${{ inputs.app_start_command }} &
          APP_PID=$!
          echo "APP_PID=$APP_PID" >> $GITHUB_ENV
          
          # ì•±ì´ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°
          echo "Waiting for app to be ready on port ${{ inputs.app_port }}..."
          for i in {1..30}; do
            if curl -s http://localhost:${{ inputs.app_port }} > /dev/null 2>&1; then
              echo "âœ… App is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
          
          # ìµœì¢… í™•ì¸
          if ! curl -s http://localhost:${{ inputs.app_port }} > /dev/null 2>&1; then
            echo "âŒ App failed to start"
            exit 1
          fi
      
      # ZAP Baseline Scan ì‹¤í–‰
      - name: Run ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.7.0
        with:
          target: ${{ inputs.target_url }}
          rules_file_name: ${{ inputs.rules_file }}
          cmd_options: '-a'
          allow_issue_writing: false
          fail_action: false
      
      # ìŠ¤ìº” ê²°ê³¼ ì—…ë¡œë“œ
      - name: Upload ZAP Scan Report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: zap-baseline-report
          path: report_html.html
          retention-days: 30
      
      # ì•± ì¢…ë£Œ
      - name: Stop application
        if: always()
        run: |
          if [ ! -z "${{ env.APP_PID }}" ]; then
            kill ${{ env.APP_PID }} || true
          fi
      
      # PRì— ê²°ê³¼ ì½”ë©˜íŠ¸
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            let alertCount = 0;
            let highAlerts = 0;
            let mediumAlerts = 0;
            
            // report_md.md íŒŒì¼ì´ ìˆìœ¼ë©´ íŒŒì‹±
            if (fs.existsSync('report_md.md')) {
              const report = fs.readFileSync('report_md.md', 'utf8');
              // ê°„ë‹¨í•œ íŒŒì‹± (ì‹¤ì œë¡œëŠ” ë” ì •êµí•˜ê²Œ)
              alertCount = (report.match(/##/g) || []).length;
            }
            
            const comment = `## ğŸ” OWASP ZAP Baseline Scan Results
            
            **Scan Type:** Baseline (Passive)
            **Target:** ${{ inputs.target_url }}
            **Alerts Found:** ${alertCount}
            
            ğŸ“‹ **Next Steps:**
            1. Download the full HTML report from Artifacts
            2. Review all findings
            3. Fix HIGH and MEDIUM severity issues
            4. Consider false positives
            
            **ğŸ“Š Report:**
            - HTML Report available in Actions Artifacts (30 days)
            - Review detailed findings and remediation steps
            
            **â„¹ï¸ Note:** Baseline scan is passive and safe - no attacks performed.
            
            **ğŸ” Common Issues:**
            - Missing security headers (X-Frame-Options, CSP)
            - Cookie security flags (Secure, HttpOnly)
            - Information disclosure in error pages
            - Outdated JavaScript libraries (check with Trivy too!)`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
  
  # 3ë‹¨ê³„: ë¹„í™œì„±í™” ì•Œë¦¼
  notify-disabled:
    needs: check-topic
    if: needs.check-topic.outputs.enabled == 'false' && github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    
    steps:
      - name: Notify that scan is disabled
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'â„¹ï¸ OWASP ZAP Baseline scan is not enabled for this repository.\n\nTo enable: Add `auto-zap-baseline` topic in repository Settings.'
            });
