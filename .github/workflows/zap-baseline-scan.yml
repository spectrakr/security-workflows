# =============================================================================
# ZAP Baseline Scan - ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ì›Œí¬í”Œë¡œìš°
# =============================================================================
# ëª©ì : ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ê¸°ë³¸ ë³´ì•ˆ ì·¨ì•½ì  ìŠ¤ìº”
# ë°©ì‹: ìˆ˜ë™ ìŠ¤ìº” (Passive) - ì‹¤ì œ ê³µê²© ì—†ìŒ, ì•ˆì „í•¨
# ì†Œìš”ì‹œê°„: 5-10ë¶„
# 
# í™œì„±í™” ë°©ë²• (ìë™):
#   gh repo edit YOUR-ORG/YOUR-REPO --add-topic auto-zap-baseline
# 
# ìˆ˜ë™ ì‹¤í–‰:
#   security.ymlì˜ workflow_dispatchë¡œ force_run: true ì „ë‹¬
# =============================================================================

name: Reusable ZAP Baseline Scan

on:
  workflow_call:
    inputs:
      force_run:
        required: false
        type: boolean
        default: false
        description: 'í† í”½ ì—†ì´ ê°•ì œ ì‹¤í–‰'
      
      # ìŠ¤ìº” ëŒ€ìƒ URL
      target_url:
        required: true
        type: string
        description: 'ìŠ¤ìº”í•  URL (ì˜ˆ: http://localhost:3000)'
      
      # ì•± ì‹œì‘ ëª…ë ¹ì–´
      app_start_command:
        required: true
        type: string
        description: 'ì•± ì‹œì‘ ëª…ë ¹ì–´'
      
      # ì•± ì‹¤í–‰ í¬íŠ¸
      app_port:
        required: false
        type: string
        default: '3000'
        description: 'ì•± í¬íŠ¸'

jobs:
  # ---------------------------------------------------------------------------
  # Job 1: í† í”½ í™•ì¸ ë˜ëŠ” ê°•ì œ ì‹¤í–‰
  # ---------------------------------------------------------------------------
  check-topic:
    name: Check Topic or Force Run
    runs-on: ubuntu-latest
    outputs:
      enabled: ${{ steps.check.outputs.enabled }}
    
    steps:
      - name: Check for auto-zap-baseline topic or force_run
        id: check
        uses: actions/github-script@v6
        with:
          script: |
            // force_runì´ trueë©´ ë¬´ì¡°ê±´ ì‹¤í–‰
            if (${{ inputs.force_run }}) {
              core.setOutput('enabled', 'true');
              console.log('âœ… ZAP Baseline scan enabled (force_run = true)');
              console.log('ğŸ’¡ Running without topic check');
              return;
            }
            
            // í† í”½ í™•ì¸
            const repo = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            const topics = repo.data.topics || [];
            
            if (topics.includes('auto-zap-baseline')) {
              core.setOutput('enabled', 'true');
              console.log('âœ… ZAP Baseline scan enabled (auto-zap-baseline topic found)');
            } else {
              core.setOutput('enabled', 'false');
              console.log('â­ï¸ ZAP Baseline scan disabled (no auto-zap-baseline topic)');
              console.log('ğŸ’¡ Tip: Add topic with "gh repo edit --add-topic auto-zap-baseline"');
            }

  # ---------------------------------------------------------------------------
  # Job 2: ZAP Baseline ìŠ¤ìº” ì‹¤í–‰
  # ---------------------------------------------------------------------------
  zap-baseline:
    name: Run ZAP Baseline Scan
    needs: check-topic
    if: needs.check-topic.outputs.enabled == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ë° ì¤€ë¹„ ëŒ€ê¸°
      - name: Start application
        run: |
          echo "ğŸš€ Starting application..."
          
          # ë°±ê·¸ë¼ìš´ë“œë¡œ ì•± ì‹œì‘
          ${{ inputs.app_start_command }} &
          APP_PID=$!
          echo "APP_PID=$APP_PID" >> $GITHUB_ENV
          
          # ì•±ì´ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸° (ìµœëŒ€ 60ì´ˆ)
          echo "â³ Waiting for app to be ready..."
          for i in {1..30}; do
            # /health ë˜ëŠ” / ê²½ë¡œë¡œ í—¬ìŠ¤ì²´í¬
            if curl -s http://localhost:${{ inputs.app_port }}/health > /dev/null 2>&1 || \
               curl -s http://localhost:${{ inputs.app_port }} > /dev/null 2>&1; then
              echo "âœ… App is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
      
      # ZAP Docker ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
      - name: Pull ZAP Docker image
        run: |
          echo "ğŸ“¦ Pulling ZAP Docker image..."
          docker pull ghcr.io/zaproxy/zaproxy:stable
      
      # ZAP Baseline ìŠ¤ìº” ì‹¤í–‰
      - name: Run ZAP Baseline Scan
        run: |
          echo "ğŸ” Running ZAP Baseline Scan..."
          echo "Target: ${{ inputs.target_url }}"
          
          docker run --rm \
            --user root \
            --network host \
            -v ${{ github.workspace }}:/zap/wrk:rw \
            -t ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
            -t ${{ inputs.target_url }} \
            -r report_html.html \
            -w report_md.md \
            -J report_json.json || true
          
          echo "âœ… Scan completed"
        continue-on-error: true
      
      # ë¦¬í¬íŠ¸ ì—…ë¡œë“œ (Artifacts)
      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-baseline-report-${{ github.run_number }}
          path: |
            report_html.html
            report_md.md
            report_json.json
          retention-days: 7
      
      # ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ
      - name: Stop application
        if: always()
        run: |
          if [ ! -z "${{ env.APP_PID }}" ]; then
            kill ${{ env.APP_PID }} 2>/dev/null || true
            echo "âœ… Application stopped"
          fi
      
      # ìŠ¤ìº” ìš”ì•½
      - name: Summary
        if: always()
        run: |
          echo "=========================================="
          echo "ZAP Baseline Scan Summary"
          echo "=========================================="
          echo "Target: ${{ inputs.target_url }}"
          echo "Method: Passive scan (safe)"
          echo "Duration: ~5-10 minutes"
          echo "=========================================="
          echo ""
          echo "ğŸ“Š Download report: Actions â†’ Artifacts"

# =============================================================================
# ì°¸ê³ ì‚¬í•­:
# 
# ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ:
#   Actions â†’ ì‹¤í–‰ í´ë¦­ â†’ Artifacts â†’ zap-baseline-report ë‹¤ìš´ë¡œë“œ
# 
# ê²€ì‚¬ í•­ëª©:
#   - ë³´ì•ˆ í—¤ë” ëˆ„ë½ (CSP, X-Frame-Options ë“±)
#   - Cookie ì„¤ì • ì˜¤ë¥˜ (Secure, HttpOnly í”Œë˜ê·¸)
#   - ì •ë³´ ë…¸ì¶œ (ì—ëŸ¬ ë©”ì‹œì§€, ë²„ì „ ì •ë³´)
#   - ì·¨ì•½í•œ SSL/TLS ì„¤ì •
# 
# í”„ë¡œì íŠ¸ë³„ ì‹œì‘ ëª…ë ¹ì–´ ì˜ˆì‹œ:
#   Node.js:  'npm install && npm start'
#   React:    'npm install && npm run build && npx serve -s build -l 3000'
#   Python:   'pip install -r requirements.txt && python app.py'
#   Django:   'pip install -r requirements.txt && python manage.py runserver'
# =============================================================================
