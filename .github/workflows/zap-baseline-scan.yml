# =============================================================================
# ZAP Baseline Scan - 재사용 가능한 워크플로우
# =============================================================================
# 목적: 웹 애플리케이션의 기본 보안 취약점 스캔
# 방식: 수동 스캔 (Passive) - 실제 공격 없음, 안전함
# 소요시간: 5-10분
# =============================================================================

name: Reusable ZAP Baseline Scan

on:
  workflow_call:
    inputs:
      force_run:
        required: false
        type: boolean
        default: false
        description: '토픽 없이 강제 실행'

      target_url:
        required: true
        type: string
        description: '스캔할 URL (예: http://localhost:3000)'

      app_start_command:
        required: true
        type: string
        description: '앱 시작 명령어'

      app_port:
        required: false
        type: string
        default: '3000'
        description: '앱 포트'

jobs:
  check-topic:
    name: Check Topic or Force Run
    runs-on: self-hosted
    outputs:
      enabled: ${{ steps.check.outputs.enabled }}

    steps:
      - name: Check for auto-zap-baseline topic or force_run
        id: check
        uses: actions/github-script@v6
        with:
          script: |
            if (${{ inputs.force_run }}) {
              core.setOutput('enabled', 'true');
              return;
            }
            const repo = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            const topics = repo.data.topics || [];
            if (topics.includes('auto-zap-baseline')) {
              core.setOutput('enabled', 'true');
              console.log('ZAP Baseline scan enabled (auto-zap-baseline topic found)');
            } else {
              core.setOutput('enabled', 'false');
              console.log('ZAP Baseline scan disabled (no auto-zap-baseline topic)');
              console.log('Tip: gh repo edit --add-topic auto-zap-baseline');
            }

  zap-baseline:
    name: Run ZAP Baseline Scan
    needs: check-topic
    if: needs.check-topic.outputs.enabled == 'true'
    runs-on: self-hosted
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 애플리케이션 시작 및 준비 대기
      - name: Start application
        run: |
          echo "Starting application..."
          ${{ inputs.app_start_command }} &
          APP_PID=$!
          echo "APP_PID=$APP_PID" >> $GITHUB_ENV

          echo "Waiting for app to be ready..."
          for i in {1..30}; do
            if curl -s http://localhost:${{ inputs.app_port }}/health > /dev/null 2>&1 || \
               curl -s http://localhost:${{ inputs.app_port }} > /dev/null 2>&1; then
              echo "App is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done

      # ZAP Docker 이미지 다운로드
      - name: Pull ZAP Docker image
        run: docker pull ghcr.io/zaproxy/zaproxy:stable

      # ZAP Baseline 스캔 실행 (HTML만 생성)
      - name: Run ZAP Baseline Scan
        run: |
          echo "Running ZAP Baseline Scan..."
          echo "Target: ${{ inputs.target_url }}"

          docker run --rm \
            --user root \
            --network host \
            -v ${{ github.workspace }}:/zap/wrk:rw \
            -t ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
            -t ${{ inputs.target_url }} \
            -r report_html.html || true

          echo "Scan completed"
        continue-on-error: true

      # HTML 리포트만 업로드 (3일 보관)
      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-baseline-report-${{ github.run_number }}
          path: report_html.html
          retention-days: 3
          compression-level: 6

      # 애플리케이션 종료
      - name: Stop application
        if: always()
        run: |
          if [ ! -z "${{ env.APP_PID }}" ]; then
            kill ${{ env.APP_PID }} 2>/dev/null || true
          fi
