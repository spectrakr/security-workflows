# =============================================================================
# ZAP Baseline Scan - ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ì›Œí¬í”Œë¡œìš°
# =============================================================================
# ëª©ì : ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ê¸°ë³¸ ë³´ì•ˆ ì·¨ì•½ì  ìŠ¤ìº”
# ë°©ì‹: ìˆ˜ë™ ìŠ¤ìº” (Passive) - ì‹¤ì œ ê³µê²© ì—†ìŒ, ì•ˆì „í•¨
# ì†Œìš”ì‹œê°„: 5-10ë¶„
# 
# í™œì„±í™” ë°©ë²•:
#   gh repo edit YOUR-ORG/YOUR-REPO --add-topic auto-zap-baseline
# 
# ì‚¬ìš© ì˜ˆì‹œ:
#   jobs:
#     zap-baseline:
#       uses: spectrakr/security-workflows/.github/workflows/zap-baseline-scan.yml@main
#       with:
#         target_url: 'http://localhost:3000'
#         app_start_command: 'npm install && npm start'
#         app_port: '3000'
# =============================================================================

name: Reusable ZAP Baseline Scan

on:
  workflow_call:
    inputs:
      # ìŠ¤ìº” ëŒ€ìƒ URL
      target_url:
        required: true
        type: string
        description: 'ìŠ¤ìº”í•  URL (ì˜ˆ: http://localhost:3000)'
      
      # ì•± ì‹œì‘ ëª…ë ¹ì–´ (ì˜ì¡´ì„± ì„¤ì¹˜ í¬í•¨)
      app_start_command:
        required: true
        type: string
        description: 'ì•± ì‹œì‘ ëª…ë ¹ì–´ (ì˜ˆ: npm install && npm start)'
      
      # ì•± ì‹¤í–‰ í¬íŠ¸
      app_port:
        required: false
        type: string
        default: '3000'
        description: 'ì•± í¬íŠ¸ ë²ˆí˜¸'

jobs:
  # ---------------------------------------------------------------------------
  # Job 1: í† í”½ í™•ì¸ - auto-zap-baseline í† í”½ì´ ìˆëŠ”ì§€ ì²´í¬
  # ---------------------------------------------------------------------------
  check-topic:
    name: Check Topic
    runs-on: ubuntu-latest
    outputs:
      enabled: ${{ steps.check.outputs.enabled }}
    
    steps:
      - name: Check for auto-zap-baseline topic
        id: check
        uses: actions/github-script@v6
        with:
          script: |
            // GitHub APIë¡œ ì €ì¥ì†Œ í† í”½ í™•ì¸
            const repo = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            const topics = repo.data.topics || [];
            if (topics.includes('auto-zap-baseline')) {
              core.setOutput('enabled', 'true');
              console.log('âœ… ZAP Baseline scan enabled');
            } else {
              core.setOutput('enabled', 'false');
              console.log('â­ï¸ ZAP Baseline scan disabled (no auto-zap-baseline topic)');
            }

  # ---------------------------------------------------------------------------
  # Job 2: ZAP Baseline ìŠ¤ìº” ì‹¤í–‰
  # ---------------------------------------------------------------------------
  zap-baseline:
    name: Run ZAP Baseline Scan
    needs: check-topic
    if: needs.check-topic.outputs.enabled == 'true'
    runs-on: ubuntu-latest
    
    steps:
      # ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v3
      
      # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ë° ì¤€ë¹„ ëŒ€ê¸°
      - name: Start application
        run: |
          echo "ğŸš€ Starting application..."
          
          # ë°±ê·¸ë¼ìš´ë“œë¡œ ì•± ì‹œì‘
          ${{ inputs.app_start_command }} &
          APP_PID=$!
          echo "APP_PID=$APP_PID" >> $GITHUB_ENV
          
          # ì•±ì´ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸° (ìµœëŒ€ 60ì´ˆ)
          echo "â³ Waiting for app to be ready..."
          for i in {1..30}; do
            # /health ë˜ëŠ” / ê²½ë¡œë¡œ í—¬ìŠ¤ì²´í¬
            if curl -s http://localhost:${{ inputs.app_port }}/health > /dev/null 2>&1 || \
               curl -s http://localhost:${{ inputs.app_port }} > /dev/null 2>&1; then
              echo "âœ… App is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
      
      # ZAP Docker ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
      - name: Pull ZAP Docker image
        run: |
          echo "ğŸ“¦ Pulling ZAP Docker image..."
          docker pull ghcr.io/zaproxy/zaproxy:stable
      
      # ZAP Baseline ìŠ¤ìº” ì‹¤í–‰
      - name: Run ZAP Baseline Scan
        run: |
          echo "ğŸ” Running ZAP Baseline Scan..."
          
          # ZAP ìŠ¤ìº” ì‹¤í–‰
          # --rm: ì»¨í…Œì´ë„ˆ ì¢…ë£Œ ì‹œ ìë™ ì‚­ì œ
          # --network host: localhost ì ‘ê·¼ ê°€ëŠ¥
          # -v: ë³¼ë¥¨ ë§ˆìš´íŠ¸ (ë¦¬í¬íŠ¸ íŒŒì¼ ì €ì¥)
          # || true: ì·¨ì•½ì  ë°œê²¬ ì‹œì—ë„ ê³„ì† ì§„í–‰
          docker run --rm \
            --user root \
            --network host \
            -v ${{ github.workspace }}:/zap/wrk:rw \
            -t ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
            -t ${{ inputs.target_url }} \
            -r report_html.html \
            -w report_md.md \
            -J report_json.json || true
          
          echo "âœ… Scan completed"
        continue-on-error: true
      
      # ë¦¬í¬íŠ¸ ì—…ë¡œë“œ (Artifacts)
      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-baseline-report
          path: |
            report_html.html
            report_md.md
            report_json.json
          retention-days: 7
      
      # ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ
      - name: Stop application
        if: always()
        run: |
          if [ ! -z "${{ env.APP_PID }}" ]; then
            kill ${{ env.APP_PID }} 2>/dev/null || true
            echo "âœ… Application stopped"
          fi

# =============================================================================
# ì°¸ê³ ì‚¬í•­:
# 
# ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ:
#   Actions â†’ ì‹¤í–‰ í´ë¦­ â†’ Artifacts â†’ zap-baseline-report ë‹¤ìš´ë¡œë“œ
# 
# ë¬¸ì œ í•´ê²°:
#   - ì•± ì‹œì‘ ì‹¤íŒ¨: app_start_command í™•ì¸
#   - ì—°ê²° ì‹¤íŒ¨: target_urlê³¼ app_port ì¼ì¹˜ í™•ì¸
#   - ë¦¬í¬íŠ¸ ë¹„ì–´ìˆìŒ: ì•±ì´ ì •ìƒ ì‹œì‘ë˜ì—ˆëŠ”ì§€ ë¡œê·¸ í™•ì¸
# 
# í”„ë¡œì íŠ¸ë³„ ì„¤ì • ì˜ˆì‹œ:
#   Node.js:  'npm install && npm start'
#   React:    'npm install && npm run build && npx serve -s build -l 3000'
#   Python:   'pip install -r requirements.txt && python app.py'
#   Django:   'pip install -r requirements.txt && python manage.py runserver 0.0.0.0:8000'
# =============================================================================
