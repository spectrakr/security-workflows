# =============================================================================
# ZAP Full Scan - 재사용 가능한 워크플로우
# =============================================================================
# 목적: 웹 애플리케이션의 전체 보안 스캔
# 방식: 능동 스캔 (Active) - 실제 공격 수행!
# 소요시간: 20-60분
#
# 주의: 실제 공격을 수행합니다 (SQL Injection, XSS 등)
#       절대 프로덕션 환경에서 실행 금지!
# =============================================================================

name: Reusable ZAP Full Scan

on:
  workflow_call:
    inputs:
      force_run:
        required: false
        type: boolean
        default: false
        description: '토픽 없이 강제 실행'

      target_url:
        required: true
        type: string
        description: '테스트 환경 URL만 입력!'

      app_start_command:
        required: true
        type: string
        description: '앱 시작 명령어'

      app_port:
        required: false
        type: string
        default: '3000'
        description: '앱 포트'

      scan_timeout:
        required: false
        type: string
        default: '60'
        description: '스캔 타임아웃 (분, 기본: 60)'

jobs:
  check-topic:
    name: Check Topic or Force Run
    runs-on: self-hosted
    outputs:
      enabled: ${{ steps.check.outputs.enabled }}

    steps:
      - name: Check for auto-zap-full topic or force_run
        id: check
        uses: actions/github-script@v6
        with:
          script: |
            if (${{ inputs.force_run }}) {
              core.setOutput('enabled', 'true');
              console.log('WARNING: This will perform ACTIVE attacks!');
              return;
            }
            const repo = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            const topics = repo.data.topics || [];
            if (topics.includes('auto-zap-full')) {
              core.setOutput('enabled', 'true');
              console.log('WARNING: This will perform ACTIVE attacks!');
            } else {
              core.setOutput('enabled', 'false');
              console.log('ZAP Full scan disabled (no auto-zap-full topic)');
            }

  zap-full:
    name: Run ZAP Full Scan (Active Attacks)
    needs: check-topic
    if: needs.check-topic.outputs.enabled == 'true'
    runs-on: self-hosted
    timeout-minutes: 90

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 애플리케이션 시작
      - name: Start application
        run: |
          echo "WARNING: Starting application for FULL SCAN (ACTIVE ATTACKS)"
          echo "Target: ${{ inputs.target_url }}"

          ${{ inputs.app_start_command }} &
          APP_PID=$!
          echo "APP_PID=$APP_PID" >> $GITHUB_ENV

          for i in {1..30}; do
            if curl -s http://localhost:${{ inputs.app_port }}/health > /dev/null 2>&1 || \
               curl -s http://localhost:${{ inputs.app_port }} > /dev/null 2>&1; then
              echo "App ready!"
              break
            fi
            sleep 2
          done

      # ZAP Docker 이미지 다운로드
      - name: Pull ZAP Docker image
        run: docker pull ghcr.io/zaproxy/zaproxy:stable

      # ZAP Full 스캔 실행 (HTML만 생성)
      - name: Run ZAP Full Scan
        run: |
          echo "Running ZAP Full Scan (ACTIVE ATTACKS)..."
          echo "Target: ${{ inputs.target_url }}"
          echo "Timeout: ${{ inputs.scan_timeout }} minutes"

          docker run --rm \
            --user root \
            --network host \
            -v ${{ github.workspace }}:/zap/wrk:rw \
            -t ghcr.io/zaproxy/zaproxy:stable \
            zap-full-scan.py \
            -t ${{ inputs.target_url }} \
            -r report_html.html \
            -m ${{ inputs.scan_timeout }} || true

          echo "Scan completed"
        continue-on-error: true

      # HTML 리포트만 업로드 (3일 보관)
      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-full-report-${{ github.run_number }}
          path: report_html.html
          retention-days: 3
          compression-level: 6

      # 애플리케이션 종료
      - name: Stop application
        if: always()
        run: |
          if [ ! -z "${{ env.APP_PID }}" ]; then
            kill ${{ env.APP_PID }} 2>/dev/null || true
          fi
