# =============================================================================
# ZAP Full Scan - ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ì›Œí¬í”Œë¡œìš°
# =============================================================================
# ëª©ì : ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì „ì²´ ë³´ì•ˆ ìŠ¤ìº”
# ë°©ì‹: ëŠ¥ë™ ìŠ¤ìº” (Active) - ì‹¤ì œ ê³µê²© ìˆ˜í–‰!
# ì†Œìš”ì‹œê°„: 20-60ë¶„
# 
# âš ï¸ ê²½ê³ :
#   - ì‹¤ì œ ê³µê²©ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤ (SQL Injection, XSS ë“±)
#   - ì ˆëŒ€ í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ ì‹¤í–‰ ê¸ˆì§€!
# =============================================================================

name: Reusable ZAP Full Scan

on:
  workflow_call:
    inputs:
      force_run:
        required: false
        type: boolean
        default: false
        description: 'í† í”½ ì—†ì´ ê°•ì œ ì‹¤í–‰'
      
      target_url:
        required: true
        type: string
        description: 'âš ï¸ í…ŒìŠ¤íŠ¸ í™˜ê²½ URLë§Œ ì…ë ¥!'
      
      app_start_command:
        required: true
        type: string
        description: 'ì•± ì‹œì‘ ëª…ë ¹ì–´'
      
      app_port:
        required: false
        type: string
        default: '3000'
        description: 'ì•± í¬íŠ¸'
      
      scan_timeout:
        required: false
        type: string
        default: '60'
        description: 'ìŠ¤ìº” íƒ€ì„ì•„ì›ƒ (ë¶„, ê¸°ë³¸: 60)'

jobs:
  # ---------------------------------------------------------------------------
  # Job 1: í† í”½ í™•ì¸ ë˜ëŠ” ê°•ì œ ì‹¤í–‰
  # ---------------------------------------------------------------------------
  check-topic:
    name: Check Topic or Force Run
    runs-on: self-hosted
    outputs:
      enabled: ${{ steps.check.outputs.enabled }}
    
    steps:
      - name: Check for auto-zap-full topic or force_run
        id: check
        uses: actions/github-script@v6
        with:
          script: |
            // force_runì´ trueë©´ ë¬´ì¡°ê±´ ì‹¤í–‰
            if (${{ inputs.force_run }}) {
              core.setOutput('enabled', 'true');
              console.log('âœ… ZAP Full scan enabled (force_run = true)');
              console.log('âš ï¸ WARNING: This will perform ACTIVE attacks!');
              console.log('ğŸ’¡ Make sure target is a TEST environment!');
              return;
            }
            
            // í† í”½ í™•ì¸
            const repo = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            const topics = repo.data.topics || [];
            
            if (topics.includes('auto-zap-full')) {
              core.setOutput('enabled', 'true');
              console.log('âœ… ZAP Full scan enabled (auto-zap-full topic found)');
              console.log('âš ï¸ WARNING: This will perform ACTIVE attacks!');
            } else {
              core.setOutput('enabled', 'false');
              console.log('â­ï¸ ZAP Full scan disabled (no auto-zap-full topic)');
              console.log('ğŸ’¡ Tip: Add topic with "gh repo edit --add-topic auto-zap-full"');
            }

  # ---------------------------------------------------------------------------
  # Job 2: ZAP Full ìŠ¤ìº” ì‹¤í–‰ (âš ï¸ ì‹¤ì œ ê³µê²© ìˆ˜í–‰!)
  # ---------------------------------------------------------------------------
  zap-full:
    name: Run ZAP Full Scan (âš ï¸ Active Attacks)
    needs: check-topic
    if: needs.check-topic.outputs.enabled == 'true'
    runs-on: self-hosted
    timeout-minutes: 90
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘
      - name: Start application
        run: |
          echo "âš ï¸ Starting application for FULL SCAN..."
          echo "âš ï¸ This app will receive ACTIVE ATTACKS!"
          echo "âš ï¸ Target: ${{ inputs.target_url }}"
          
          ${{ inputs.app_start_command }} &
          APP_PID=$!
          echo "APP_PID=$APP_PID" >> $GITHUB_ENV
          
          echo "â³ Waiting for app..."
          for i in {1..30}; do
            if curl -s http://localhost:${{ inputs.app_port }}/health > /dev/null 2>&1 || \
               curl -s http://localhost:${{ inputs.app_port }} > /dev/null 2>&1; then
              echo "âœ… App ready!"
              break
            fi
            sleep 2
          done
      
      # ZAP Docker ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
      - name: Pull ZAP Docker image
        run: docker pull ghcr.io/zaproxy/zaproxy:stable
      
      # ZAP Full ìŠ¤ìº” ì‹¤í–‰ (âš ï¸ ì‹¤ì œ ê³µê²©)
      - name: Run ZAP Full Scan
        run: |
          echo "ğŸ”¥ Running ZAP Full Scan (ACTIVE ATTACKS)..."
          echo "âš ï¸ Performing: SQL Injection, XSS, Path Traversal, etc."
          echo "Target: ${{ inputs.target_url }}"
          echo "Timeout: ${{ inputs.scan_timeout }} minutes"
          
          docker run --rm \
            --user root \
            --network host \
            -v ${{ github.workspace }}:/zap/wrk:rw \
            -t ghcr.io/zaproxy/zaproxy:stable \
            zap-full-scan.py \
            -t ${{ inputs.target_url }} \
            -r report_html.html \
            -w report_md.md \
            -J report_json.json \
            -m ${{ inputs.scan_timeout }} || true
          
          echo "âœ… Scan completed"
        continue-on-error: true
      
      # ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-full-report-${{ github.run_number }}
          path: |
            report_html.html
            report_md.md
            report_json.json
          retention-days: 7
      
      # ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ
      - name: Stop application
        if: always()
        run: |
          if [ ! -z "${{ env.APP_PID }}" ]; then
            kill ${{ env.APP_PID }} 2>/dev/null || true
          fi
      
      # ì™„ë£Œ ì•Œë¦¼
      - name: Scan Complete
        if: always()
        run: |
          echo "=========================================="
          echo "âš ï¸ ZAP Full Scan Complete"
          echo "=========================================="
          echo "IMPORTANT:"
          echo "  - Review all findings carefully"
          echo "  - Check for FALSE POSITIVES"
          echo "  - This scan performed ACTIVE attacks"
          echo "  - Check your application logs"
          echo "=========================================="
          echo ""
          echo "ğŸ“Š Download report: Actions â†’ Artifacts"

# =============================================================================
# ì¤‘ìš” ì‚¬í•­:
# âš ï¸ ì£¼ì˜:
#   - ì ˆëŒ€ í”„ë¡œë•ì…˜ ê¸ˆì§€!
#   - í…ŒìŠ¤íŠ¸ ë°ì´í„°ë§Œ ìˆì–´ì•¼ í•¨
#   - ì£¼ 1íšŒ ë˜ëŠ” ì›” 1íšŒ ê¶Œì¥
# =============================================================================
