# .github/workflows/zap-full-scan.yml
# OWASP ZAP Full Scan - Îä•ÎèôÏ†Å Ïä§Ï∫î (Í≥µÍ≤©Ï†Å, ÎäêÎ¶º, Í∞ïÎ†•)
# ÌÜ†ÌîΩ "auto-zap-full"Ïù¥ ÏûàÎäî Ï†ÄÏû•ÏÜåÏóêÎßå Ïã§ÌñâÎê®
# ‚ö†Ô∏è Ï£ºÏùò: Ïã§Ï†ú Í≥µÍ≤©ÏùÑ ÏàòÌñâÌïòÎØÄÎ°ú ÌÖåÏä§Ìä∏/Í∞úÎ∞ú ÌôòÍ≤ΩÏóêÎßå ÏÇ¨Ïö©!

name: Reusable ZAP Full Scan

on:
  workflow_call:
    inputs:
      target_url:
        description: 'Target URL to scan (e.g., http://localhost:3000)'
        required: true
        type: string
      app_start_command:
        description: 'Command to start the app (e.g., npm start, docker-compose up)'
        required: true
        type: string
      app_port:
        description: 'Port where app runs (default: 3000)'
        required: false
        type: string
        default: '3000'
      rules_file:
        description: 'Custom ZAP rules file path (optional)'
        required: false
        type: string
        default: ''
      scan_timeout:
        description: 'Maximum scan time in minutes (default: 60)'
        required: false
        type: string
        default: '60'

jobs:
  # 1Îã®Í≥Ñ: auto-zap-full ÌÜ†ÌîΩ ÌôïÏù∏
  check-topic:
    runs-on: ubuntu-latest
    outputs:
      enabled: ${{ steps.check.outputs.enabled }}
    
    steps:
      - name: Check for auto-zap-full topic
        id: check
        uses: actions/github-script@v6
        with:
          script: |
            const repo = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            const topics = repo.data.topics || [];
            
            if (topics.includes('auto-zap-full')) {
              core.setOutput('enabled', 'true');
              console.log('‚úÖ ZAP Full scan enabled (auto-zap-full topic found)');
            } else {
              core.setOutput('enabled', 'false');
              console.log('‚è≠Ô∏è ZAP Full scan disabled (no auto-zap-full topic)');
            }

  # 2Îã®Í≥Ñ: ZAP Full Ïä§Ï∫î Ïã§Ìñâ (ÌÜ†ÌîΩ ÏûàÏùÑ ÎïåÎßå)
  zap-full:
    needs: check-topic
    if: needs.check-topic.outputs.enabled == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      # Ïï± Ïã§Ìñâ (Î∞±Í∑∏ÎùºÏö¥Îìú)
      - name: Start application
        run: |
          echo "Starting application with: ${{ inputs.app_start_command }}"
          ${{ inputs.app_start_command }} &
          APP_PID=$!
          echo "APP_PID=$APP_PID" >> $GITHUB_ENV
          
          # Ïï±Ïù¥ Ï§ÄÎπÑÎê† ÎïåÍπåÏßÄ ÎåÄÍ∏∞
          echo "Waiting for app to be ready on port ${{ inputs.app_port }}..."
          for i in {1..30}; do
            if curl -s http://localhost:${{ inputs.app_port }} > /dev/null 2>&1; then
              echo "‚úÖ App is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
          
          # ÏµúÏ¢Ö ÌôïÏù∏
          if ! curl -s http://localhost:${{ inputs.app_port }} > /dev/null 2>&1; then
            echo "‚ùå App failed to start"
            exit 1
          fi
      
      # ZAP Full Scan Ïã§Ìñâ
      - name: Run ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.7.0
        with:
          target: ${{ inputs.target_url }}
          rules_file_name: ${{ inputs.rules_file }}
          cmd_options: '-a -j -T ${{ inputs.scan_timeout }}'
          allow_issue_writing: false
          fail_action: false
      
      # Ïä§Ï∫î Í≤∞Í≥º ÏóÖÎ°úÎìú
      - name: Upload ZAP Scan Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-full-report
          path: |
            report_html.html
            report_json.json
            report_md.md
          retention-days: 30
      
      # Ïï± Ï¢ÖÎ£å
      - name: Stop application
        if: always()
        run: |
          if [ ! -z "${{ env.APP_PID }}" ]; then
            kill ${{ env.APP_PID }} || true
          fi
      
      # PRÏóê Í≤∞Í≥º ÏΩîÎ©òÌä∏
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            let criticalCount = 0;
            let highCount = 0;
            let mediumCount = 0;
            let lowCount = 0;
            
            // JSON Î¶¨Ìè¨Ìä∏ ÌååÏã± (Í∞ÄÎä•Ìïú Í≤ΩÏö∞)
            if (fs.existsSync('report_json.json')) {
              try {
                const report = JSON.parse(fs.readFileSync('report_json.json', 'utf8'));
                const alerts = report.site?.[0]?.alerts || [];
                
                alerts.forEach(alert => {
                  const risk = alert.riskdesc || '';
                  if (risk.includes('Critical')) criticalCount++;
                  else if (risk.includes('High')) highCount++;
                  else if (risk.includes('Medium')) mediumCount++;
                  else if (risk.includes('Low')) lowCount++;
                });
              } catch (e) {
                console.log('Error parsing JSON report:', e);
              }
            }
            
            const totalAlerts = criticalCount + highCount + mediumCount + lowCount;
            
            const comment = `## ‚ö†Ô∏è OWASP ZAP Full Scan Results
            
            **Scan Type:** Full Scan (Active Attacks)
            **Target:** ${{ inputs.target_url }}
            **Scan Duration:** ~${{ inputs.scan_timeout }} minutes max
            
            ### üìä Findings Summary
            
            | Severity | Count |
            |----------|-------|
            | üî¥ CRITICAL | ${criticalCount} |
            | üü† HIGH | ${highCount} |
            | üü° MEDIUM | ${mediumCount} |
            | üîµ LOW | ${lowCount} |
            | **Total** | **${totalAlerts}** |
            
            ### üìã Next Steps
            
            1. **Download** the full HTML/JSON reports from Artifacts
            2. **Review** CRITICAL and HIGH severity findings first
            3. **Fix** vulnerabilities before deployment:
               - SQL Injection
               - XSS (Cross-Site Scripting)
               - CSRF (Cross-Site Request Forgery)
               - Authentication/Authorization issues
               - Sensitive data exposure
            4. **Retest** after fixes
            
            ### ‚ö†Ô∏è Important Notes
            
            - This scan **actively attacks** your application
            - Only run on test/development environments
            - Review false positives carefully
            - Some alerts may require manual verification
            
            ### üîç Common Vulnerabilities Found
            
            - SQL Injection (parameterize queries)
            - XSS (sanitize user input, use CSP)
            - Missing security headers (CSP, X-Frame-Options)
            - Weak session management
            - Insecure direct object references
            
            **üìä Full Reports:** Download from Actions Artifacts (available for 30 days)`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
  
  # 3Îã®Í≥Ñ: ÎπÑÌôúÏÑ±Ìôî ÏïåÎ¶º
  notify-disabled:
    needs: check-topic
    if: needs.check-topic.outputs.enabled == 'false' && github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    
    steps:
      - name: Notify that scan is disabled
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ÑπÔ∏è OWASP ZAP Full scan is not enabled for this repository.\n\nTo enable: Add `auto-zap-full` topic in repository Settings.\n\n‚ö†Ô∏è **Warning:** Full scan performs active attacks. Only use on test/development environments!'
            });
