# .github/workflows/trivy-scan.yml
# 중앙 Trivy 보안 스캔 워크플로우
# 서비스 레포지토리의 'secrets: inherit' 설정을 통해 비밀값을 직접 참조합니다.

name: Reusable Trivy Security Scan

on:
  workflow_call:
    inputs:
      force_run:
        required: false
        type: boolean
        default: false
      image_ref:
        required: false
        type: string
        default: ''

jobs:
  check-topic:
    runs-on: ubuntu-latest
    outputs:
      enabled: ${{ steps.check.outputs.enabled }}
    steps:
      - name: Check for auto-trivy topic or force_run
        id: check
        uses: actions/github-script@v6
        with:
          script: |
            // force_run이 true거나 원격 이미지 주소가 입력되면 실행
            if (${{ inputs.force_run }} || "${{ inputs.image_ref }}" !== "") {
              core.setOutput('enabled', 'true');
              return;
            }
            const repo = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            const topics = repo.data.topics || [];
            core.setOutput('enabled', topics.includes('auto-trivy') ? 'true' : 'false');

  trivy-scan:
    needs: check-topic
    if: needs.check-topic.outputs.enabled == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1. 이미지 주소에서 레지스트리 도메인 추출 (익스프레션 오류 해결용)
      - name: Extract Registry Host
        if: inputs.image_ref != ''
        id: get_reg
        run: |
          # 슬래시(/)를 기준으로 첫 번째 파트를 추출 (예: registry-nexus.spectra.co.kr)
          DOMAIN=$(echo "${{ inputs.image_ref }}" | cut -d'/' -f1)
          echo "host=$DOMAIN" >> $GITHUB_OUTPUT

      # 2. 사내 Nexus 레지스트리 로그인 (상속받은 비밀값 직접 사용)
      - name: Login to Nexus Registry
        if: inputs.image_ref != '' && secrets.NEXUS_USER != ''
        uses: docker/login-action@v3
        with:
          registry: ${{ steps.get_reg.outputs.host }}
          username: ${{ secrets.NEXUS_USER }}
          password: ${{ secrets.NEXUS_PASSWORD }}

      # 3. 파일 시스템 스캔 (의존성 라이브러리)
      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          format: 'json'
          output: 'trivy-fs-results.json'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true

      # 4. 이미지 스캔 (원격 또는 로컬 빌드)
      - name: Run Trivy Image Scan
        uses: aquasecurity/trivy-action@master
        env:
          # Trivy 스캔 시 인증이 필요한 경우 상속받은 비밀값 사용
          TRIVY_USERNAME: ${{ secrets.NEXUS_USER }}
          TRIVY_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
        with:
          # image_ref가 있으면 원격 스캔, 없으면 Dockerfile 존재 시 로컬 빌드 스캔
          image-ref: ${{ inputs.image_ref != '' && inputs.image_ref || (hashFiles('Dockerfile') != '' && format('local-image:{0}', github.sha) || '') }}
          scan-type: 'image'
          format: 'json'
          output: 'trivy-image-results.json'
          severity: 'CRITICAL,HIGH'
        if: inputs.image_ref != '' || hashFiles('Dockerfile') != ''

      # 5. 결과 리포트 생성 및 통합
      - name: Generate HTML Reports
        if: always()
        run: |
          for f in trivy-*-results.json; do
            [ -f "$f" ] || continue
            docker run --rm -v ${{ github.workspace }}:/work aquasec/trivy:latest convert \
              --format template --template "@contrib/html.tpl" \
              --output "/work/${f%.json}.html" "/work/$f"
          done

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-security-report
          path: |
            trivy-*.json
            trivy-*.html
          retention-days: 7
