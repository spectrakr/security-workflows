# .github/workflows/trivy-scan.yml
# 중앙 Trivy 보안 스캔 워크플로우
# 토픽 "auto-trivy"가 있는 저장소에만 실행됨

name: Reusable Trivy Security Scan

on:
  workflow_call:
    inputs:
      force_run:
        required: false
        type: boolean
        default: false
      image_ref:  # 릴리즈된 원격 이미지 주소를 받기 위한 필드 추가
        required: false
        type: string
        default: ''

jobs:
  check-topic:
    runs-on: ubuntu-latest
    outputs:
      enabled: ${{ steps.check.outputs.enabled }}
    
    steps:
      - name: Check for auto-trivy topic or force_run
        id: check
        uses: actions/github-script@v6
        with:
          script: |
            if (${{ inputs.force_run }} || "${{ inputs.image_ref }}" !== "") {
              core.setOutput('enabled', 'true');
              console.log('✅ Trivy scan enabled (forced or remote image provided)');
              return;
            }
            
            const repo = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            const topics = repo.data.topics || [];
            
            if (topics.includes('auto-trivy')) {
              core.setOutput('enabled', 'true');
              console.log('✅ Trivy scan enabled (auto-trivy topic found)');
            } else {
              core.setOutput('enabled', 'false');
              console.log('⏭️ Trivy scan disabled');
            }

  trivy-scan:
    needs: check-topic
    if: needs.check-topic.outputs.enabled == 'true'
    runs-on: ubuntu-latest
    continue-on-error: ${{ github.event_name == 'pull_request' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # -----------------------------------------------------------------------
      # 1. 파일 시스템 스캔 (의존성 라이브러리)
      # -----------------------------------------------------------------------
      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          format: 'json'
          output: 'trivy-fs-results.json'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true

      # -----------------------------------------------------------------------
      # 2. 원격 릴리즈 이미지 스캔 (image_ref가 있을 경우 우선 실행)
      # -----------------------------------------------------------------------
      - name: Run Trivy on Remote Release Image
        if: inputs.image_ref != ''
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ inputs.image_ref }}
          format: 'json'
          output: 'trivy-remote-image-results.json'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true

      # -----------------------------------------------------------------------
      # 3. 로컬 Dockerfile 빌드 및 스캔 (image_ref가 없을 때만 실행)
      # -----------------------------------------------------------------------
      - name: Build Local Docker image
        if: inputs.image_ref == '' && hashFiles('Dockerfile') != ''
        run: |
          docker build -t local-scan-image:${{ github.sha }} .

      - name: Run Trivy on Local Image
        if: inputs.image_ref == '' && hashFiles('Dockerfile') != ''
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'local-scan-image:${{ github.sha }}'
          format: 'json'
          output: 'trivy-local-image-results.json'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true

      # -----------------------------------------------------------------------
      # 4. 리포트 생성 및 업로드
      # -----------------------------------------------------------------------
      - name: Generate HTML Reports
        run: |
          # 스캔 결과들을 HTML로 변환하는 로직 (기존과 동일)
          for f in trivy-*-results.json; do
            [ -e "$f" ] || continue
            output_name="${f%.json}.html"
            docker run --rm -v ${{ github.workspace }}:/work aquasec/trivy:latest convert --format template --template "@contrib/html.tpl" --output "/work/$output_name" "/work/$f"
          done
        continue-on-error: true

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: trivy-security-report
          path: |
            trivy-*.json
            trivy-*.html
          retention-days: 7
