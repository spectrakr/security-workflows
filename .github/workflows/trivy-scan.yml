# .github/workflows/trivy-scan.yml
# ì¤‘ì•™ Trivy ë³´ì•ˆ ìŠ¤ìº” ì›Œí¬í”Œë¡œìš°
# í† í”½ "auto-trivy"ê°€ ìˆëŠ” ì €ì¥ì†Œì—ë§Œ ì‹¤í–‰ë¨

name: Reusable Trivy Security Scan

# ë‹¤ë¥¸ ì €ì¥ì†Œì—ì„œ í˜¸ì¶œ ê°€ëŠ¥í•˜ê²Œ ì„¤ì •
on:
  workflow_call:
    inputs:
      force_run:
        required: false
        type: boolean
        default: false

jobs:
  # 1ë‹¨ê³„: auto-trivy í† í”½ í™•ì¸
  check-topic:
    runs-on: ubuntu-latest
    outputs:
      enabled: ${{ steps.check.outputs.enabled }}
    
    steps:
      - name: Check for auto-trivy topic or force_run
        id: check
        uses: actions/github-script@v6
        with:
          script: |
            // force_runì´ trueë©´ í† í”½ ë¬´ì‹œí•˜ê³  ì‹¤í–‰
            if (${{ inputs.force_run }}) {
              core.setOutput('enabled', 'true');
              console.log('âœ… Trivy scan enabled (force_run=true)');
              return;
            }
            
            // ì €ì¥ì†Œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const repo = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            const topics = repo.data.topics || [];
            
            // "auto-trivy" í† í”½ì´ ìˆëŠ”ì§€ í™•ì¸
            if (topics.includes('auto-trivy')) {
              core.setOutput('enabled', 'true');
              console.log('âœ… Trivy scan enabled (auto-trivy topic found)');
            } else {
              core.setOutput('enabled', 'false');
              console.log('â­ï¸ Trivy scan disabled (no auto-trivy topic)');
            }

  # 2ë‹¨ê³„: Trivy ë³´ì•ˆ ìŠ¤ìº” ì‹¤í–‰ (í† í”½ ìˆì„ ë•Œë§Œ)
  trivy-scan:
    needs: check-topic
    if: needs.check-topic.outputs.enabled == 'true'
    runs-on: ubuntu-latest
    # PRì—ì„œëŠ” ì‹¤íŒ¨í•´ë„ ë¨¸ì§€ ê°€ëŠ¥ (ê²½ê³ ë§Œ)
    continue-on-error: ${{ github.event_name == 'pull_request' }}
    
    steps:
      # ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v3
      
      # íŒŒì¼ì‹œìŠ¤í…œ ìŠ¤ìº” (JSON ë¦¬í¬íŠ¸)
      - name: Run Trivy filesystem scan (JSON)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'json'
          output: 'trivy-fs-results.json'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true
      
      # íŒŒì¼ì‹œìŠ¤í…œ ìŠ¤ìº” (ì½˜ì†” ì¶œë ¥ìš©)
      - name: Run Trivy filesystem scan (Table)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH'
      
      # Docker ì´ë¯¸ì§€ ë¹Œë“œ (Dockerfile ìˆëŠ” ê²½ìš°)
      - name: Build Docker image
        if: hashFiles('Dockerfile') != ''
        run: |
          docker build -t scan-image:${{ github.sha }} .
      
      # Docker ì´ë¯¸ì§€ ìŠ¤ìº” (JSON ë¦¬í¬íŠ¸)
      - name: Run Trivy image scan (JSON)
        if: hashFiles('Dockerfile') != ''
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          image-ref: 'scan-image:${{ github.sha }}'
          format: 'json'
          output: 'trivy-image-results.json'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true
      
      # Docker ì´ë¯¸ì§€ ìŠ¤ìº” (ì½˜ì†” ì¶œë ¥ìš©)
      - name: Run Trivy image scan (Table)
        if: hashFiles('Dockerfile') != ''
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          image-ref: 'scan-image:${{ github.sha }}'
          format: 'table'
          severity: 'CRITICAL,HIGH'
      
      # HTML ë¦¬í¬íŠ¸ ìƒì„± (íŒŒì¼ì‹œìŠ¤í…œ ìŠ¤ìº” ê²°ê³¼)
      - name: Generate HTML report from filesystem scan
        if: hashFiles('trivy-fs-results.json') != ''
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/work \
            aquasec/trivy:latest \
            convert \
            --format template \
            --template "@contrib/html.tpl" \
            --output /work/trivy-fs-report.html \
            /work/trivy-fs-results.json
        continue-on-error: true
      
      # HTML ë¦¬í¬íŠ¸ ìƒì„± (ì´ë¯¸ì§€ ìŠ¤ìº” ê²°ê³¼)
      - name: Generate HTML report from image scan
        if: hashFiles('trivy-image-results.json') != ''
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/work \
            aquasec/trivy:latest \
            convert \
            --format template \
            --template "@contrib/html.tpl" \
            --output /work/trivy-image-report.html \
            /work/trivy-image-results.json
        continue-on-error: true
      
      # ë¦¬í¬íŠ¸ ìš”ì•½ ìƒì„±
      - name: Create report summary
        if: always()
        run: |
          echo "# Trivy Security Scan Report" > report-summary.md
          echo "" >> report-summary.md
          echo "**Scan Date:** $(date)" >> report-summary.md
          echo "**Repository:** ${{ github.repository }}" >> report-summary.md
          echo "**Branch:** ${{ github.ref_name }}" >> report-summary.md
          echo "**Commit:** ${{ github.sha }}" >> report-summary.md
          echo "" >> report-summary.md
          echo "## Scan Results" >> report-summary.md
          echo "" >> report-summary.md
          
          if [ -f trivy-fs-results.json ]; then
            echo "âœ… Filesystem scan completed" >> report-summary.md
          fi
          
          if [ -f trivy-image-results.json ]; then
            echo "âœ… Docker image scan completed" >> report-summary.md
          fi
          
          echo "" >> report-summary.md
          echo "## Available Reports" >> report-summary.md
          echo "- trivy-fs-results.json (Filesystem scan - JSON)" >> report-summary.md
          echo "- trivy-fs-report.html (Filesystem scan - HTML)" >> report-summary.md
          
          if [ -f trivy-image-results.json ]; then
            echo "- trivy-image-results.json (Image scan - JSON)" >> report-summary.md
            echo "- trivy-image-report.html (Image scan - HTML)" >> report-summary.md
          fi
          
          echo "" >> report-summary.md
          echo "Download reports from Actions â†’ Artifacts â†’ trivy-security-report" >> report-summary.md
      
      # ë¦¬í¬íŠ¸ íŒŒì¼ ì—…ë¡œë“œ
      - name: Upload Trivy Security Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-security-report
          path: |
            trivy-fs-results.json
            trivy-fs-report.html
            trivy-image-results.json
            trivy-image-report.html
            report-summary.md
          retention-days: 7
      
      # PRì— ì·¨ì•½ì  ë°œê²¬ ì‹œ ìë™ ì½”ë©˜íŠ¸
      - name: Comment on PR
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v6
        with:
          script: |
            const comment = `## âš ï¸ Security Vulnerabilities Detected
            
            Trivy security scan found vulnerabilities in this PR.
            
            **ğŸ“‹ Next Steps:**
            1. Check the Actions logs for detailed vulnerability information
            2. Download the full report from Artifacts (see below)
            3. Review CRITICAL and HIGH severity issues
            4. Update vulnerable dependencies to fixed versions
            5. Push changes to re-run this scan
            
            **ğŸ“Š Download Detailed Reports:**
            Go to: Actions â†’ This workflow run â†’ Artifacts â†’ **trivy-security-report**
            
            Available reports:
            - \`trivy-fs-report.html\` - Open in browser for detailed filesystem scan results
            - \`trivy-image-report.html\` - Open in browser for Docker image scan results (if applicable)
            - \`trivy-fs-results.json\` - JSON format for automation
            - \`report-summary.md\` - Quick summary
            
            **â„¹ï¸ Note:** This is a warning - you can still merge if necessary.
            
            **ğŸ” Common Fixes:**
            - Update package.json / requirements.txt to latest secure versions
            - Rebuild Docker image with updated base image
            - Check for security patches from package maintainers`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
  
  # 3ë‹¨ê³„: ë¹„í™œì„±í™” ì•Œë¦¼ (ì„ íƒì‚¬í•­)
  notify-disabled:
    needs: check-topic
    if: needs.check-topic.outputs.enabled == 'false' && github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    
    steps:
      - name: Notify that scan is disabled
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'â„¹ï¸ Trivy security scan is not enabled for this repository.\n\nTo enable: Add `auto-trivy` topic in repository Settings.'
            });
