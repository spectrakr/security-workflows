# =============================================================================
# Trivy Security Scan - ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ì›Œí¬í”Œë¡œìš°
# =============================================================================
# ëª©ì : ì»¨í…Œì´ë„ˆ, ì˜ì¡´ì„±, íŒŒì¼ì‹œìŠ¤í…œ ë³´ì•ˆ ì·¨ì•½ì  ìŠ¤ìº”
# ë°©ì‹: ì •ì  ë¶„ì„ (CVE ë°ì´í„°ë² ì´ìŠ¤ ê¸°ë°˜)
# ì†Œìš”ì‹œê°„: 1-3ë¶„
# 
# í™œì„±í™” ë°©ë²• (ìë™):
#   gh repo edit YOUR-ORG/YOUR-REPO --add-topic auto-trivy
# 
# ìˆ˜ë™ ì‹¤í–‰:
#   security.ymlì˜ workflow_dispatchë¡œ force_run: true ì „ë‹¬
# =============================================================================

name: Reusable Trivy Security Scan

on:
  workflow_call:
    inputs:
      force_run:
        required: false
        type: boolean
        default: false
        description: 'í† í”½ ì—†ì´ ê°•ì œ ì‹¤í–‰'

jobs:
  # ---------------------------------------------------------------------------
  # Job 1: í† í”½ í™•ì¸ ë˜ëŠ” ê°•ì œ ì‹¤í–‰
  # ---------------------------------------------------------------------------
  check-topic:
    name: Check Topic or Force Run
    runs-on: ubuntu-latest
    outputs:
      enabled: ${{ steps.check.outputs.enabled }}
    
    steps:
      - name: Check for auto-trivy topic or force_run
        id: check
        uses: actions/github-script@v6
        with:
          script: |
            // force_runì´ trueë©´ ë¬´ì¡°ê±´ ì‹¤í–‰
            if (${{ inputs.force_run }}) {
              core.setOutput('enabled', 'true');
              console.log('âœ… Trivy scan enabled (force_run = true)');
              console.log('ğŸ’¡ Running without topic check');
              return;
            }
            
            // í† í”½ í™•ì¸
            const repo = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            const topics = repo.data.topics || [];
            
            if (topics.includes('auto-trivy')) {
              core.setOutput('enabled', 'true');
              console.log('âœ… Trivy scan enabled (auto-trivy topic found)');
            } else {
              core.setOutput('enabled', 'false');
              console.log('â­ï¸ Trivy scan disabled (no auto-trivy topic)');
              console.log('ğŸ’¡ Tip: Add topic with "gh repo edit --add-topic auto-trivy"');
            }

  # ---------------------------------------------------------------------------
  # Job 2: Trivy ë³´ì•ˆ ìŠ¤ìº” ì‹¤í–‰
  # ---------------------------------------------------------------------------
  trivy-scan:
    name: Run Trivy Scan
    needs: check-topic
    if: needs.check-topic.outputs.enabled == 'true'
    runs-on: ubuntu-latest
    continue-on-error: ${{ github.event_name == 'pull_request' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      # íŒŒì¼ì‹œìŠ¤í…œ ìŠ¤ìº” (ì˜ì¡´ì„± íŒŒì¼ ê²€ì‚¬)
      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH'
      
      # Docker ì´ë¯¸ì§€ ë¹Œë“œ (Dockerfile ìˆëŠ” ê²½ìš°)
      - name: Build Docker image
        if: hashFiles('Dockerfile') != ''
        run: |
          echo "ğŸ³ Building Docker image for scanning..."
          docker build -t scan-image:${{ github.sha }} .
      
      # Docker ì´ë¯¸ì§€ ìŠ¤ìº”
      - name: Run Trivy image scan
        if: hashFiles('Dockerfile') != ''
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          image-ref: 'scan-image:${{ github.sha }}'
          format: 'table'
          severity: 'CRITICAL,HIGH'
      
      # PRì— ì·¨ì•½ì  ë°œê²¬ ì‹œ ìë™ ì½”ë©˜íŠ¸
      - name: Comment on PR
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v6
        with:
          script: |
            const comment = `## âš ï¸ Security Vulnerabilities Detected
            
            Trivy security scan found vulnerabilities in this PR.
            
            **ğŸ“‹ Next Steps:**
            1. Check the Actions logs for detailed vulnerability information
            2. Review CRITICAL and HIGH severity issues
            3. Update vulnerable dependencies to fixed versions
            4. Push changes to re-run this scan
            
            **â„¹ï¸ Note:** This is a warning - you can still merge if necessary.
            
            **ğŸ” Common Fixes:**
            - Update package.json / requirements.txt to latest secure versions
            - Rebuild Docker image with updated base image
            - Check for security patches from package maintainers`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

# =============================================================================
# ì°¸ê³ ì‚¬í•­:
# 
# ê²€ì‚¬ ëŒ€ìƒ:
#   - package.json, package-lock.json (npm)
#   - requirements.txt, Pipfile.lock (Python)
#   - go.mod, go.sum (Go)
#   - pom.xml (Maven)
#   - Dockerfile ê¸°ë°˜ ì´ë¯¸ì§€
# 
# ì‹¬ê°ë„ ë ˆë²¨:
#   - CRITICAL: ì¦‰ì‹œ ìˆ˜ì • í•„ìš”
#   - HIGH: ìš°ì„  ìˆ˜ì • ê¶Œì¥
#   - MEDIUM, LOW: ê²€í†  í›„ ìˆ˜ì •
# 
# False Positive ì²˜ë¦¬:
#   .trivyignore íŒŒì¼ ìƒì„±:
#   
#   # í”„ë ˆì„ì›Œí¬ê°€ ìë™ ì²˜ë¦¬
#   CVE-2021-12345
#   
#   # ë‹¤ìŒ ìŠ¤í”„ë¦°íŠ¸ì— ìˆ˜ì • ì˜ˆì •
#   CVE-2021-67890
# =============================================================================
