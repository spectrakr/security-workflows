# .github/workflows/trivy-scan.yml
# 중앙 Trivy 보안 스캔 워크플로우

name: Reusable Trivy Security Scan

on:
  workflow_call:
    inputs:
      force_run:
        required: false
        type: boolean
        default: false
      image_ref:
        required: false
        type: string
        default: ''
    secrets:
      NEXUS_USER:
        required: false
      NEXUS_PASSWORD:
        required: false

jobs:
  check-topic:
    runs-on: self-hosted
    outputs:
      enabled: ${{ steps.check.outputs.enabled }}

    steps:
      - name: Check for auto-trivy topic or force_run
        id: check
        uses: actions/github-script@v6
        with:
          script: |
            if (${{ inputs.force_run }} || "${{ inputs.image_ref }}" !== "") {
              core.setOutput('enabled', 'true');
              return;
            }
            const repo = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            const topics = repo.data.topics || [];
            core.setOutput('enabled', topics.includes('auto-trivy') ? 'true' : 'false');

  trivy-scan:
    needs: check-topic
    if: needs.check-topic.outputs.enabled == 'true'
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1. 이미지 주소에서 레지스트리 도메인 추출
      - name: Extract Registry Host
        if: inputs.image_ref != ''
        id: get_reg
        run: |
          DOMAIN=$(echo "${{ inputs.image_ref }}" | cut -d'/' -f1)
          echo "host=$DOMAIN" >> $GITHUB_OUTPUT

      # 2. 사내 Nexus 레지스트리 로그인
      - name: Login to Nexus Registry
        if: inputs.image_ref != ''
        uses: docker/login-action@v3
        with:
          registry: ${{ steps.get_reg.outputs.host }}
          username: ${{ secrets.NEXUS_USER }}
          password: ${{ secrets.NEXUS_PASSWORD }}

      # 3. 파일시스템 스캔 (JSON → HTML 변환용 중간 파일)
      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          format: 'json'
          output: 'trivy-fs-results.json'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true

      # 4. 이미지 스캔 (JSON → HTML 변환용 중간 파일)
      - name: Run Trivy Image Scan
        uses: aquasecurity/trivy-action@master
        env:
          TRIVY_USERNAME: ${{ secrets.NEXUS_USER }}
          TRIVY_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
        with:
          image-ref: ${{ inputs.image_ref != '' && inputs.image_ref || (hashFiles('Dockerfile') != '' && format('local-image:{0}', github.sha) || '') }}
          scan-type: 'image'
          format: 'json'
          output: 'trivy-image-results.json'
          severity: 'CRITICAL,HIGH'
        if: inputs.image_ref != '' || hashFiles('Dockerfile') != ''
        continue-on-error: true

      # 5. JSON → HTML 변환 (업로드용)
      - name: Generate HTML Reports
        if: always()
        run: |
          for f in trivy-*-results.json; do
            [ -f "$f" ] || continue
            docker run --rm -v ${{ github.workspace }}:/work aquasec/trivy:latest convert \
              --format template --template "@contrib/html.tpl" \
              --output "/work/${f%.json}.html" "/work/$f"
          done

      # 6. HTML 리포트만 업로드 (3일 보관)
      - name: Upload Vulnerability Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-security-report-${{ github.run_number }}
          path: |
            trivy-*.html
          retention-days: 3
          compression-level: 6
