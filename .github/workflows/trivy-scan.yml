# .github/workflows/trivy-scan.yml
# ì¤‘ì•™ Trivy ë³´ì•ˆ ìŠ¤ìº” ì›Œí¬í”Œë¡œìš°
# í† í”½ "auto-trivy"ê°€ ìˆëŠ” ì €ì¥ì†Œì—ë§Œ ì‹¤í–‰ë¨

name: Reusable Trivy Security Scan

# ë‹¤ë¥¸ ì €ì¥ì†Œì—ì„œ í˜¸ì¶œ ê°€ëŠ¥í•˜ê²Œ ì„¤ì •
on:
  workflow_call:

jobs:
  # 1ë‹¨ê³„: auto-trivy í† í”½ í™•ì¸
  check-topic:
    runs-on: ubuntu-latest
    outputs:
      enabled: ${{ steps.check.outputs.enabled }}
    
    steps:
      - name: Check for auto-trivy topic
        id: check
        uses: actions/github-script@v6
        with:
          script: |
            // ì €ì¥ì†Œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const repo = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            const topics = repo.data.topics || [];
            
            // "auto-trivy" í† í”½ì´ ìˆëŠ”ì§€ í™•ì¸
            if (topics.includes('auto-trivy')) {
              core.setOutput('enabled', 'true');
              console.log('âœ… Trivy scan enabled (auto-trivy topic found)');
            } else {
              core.setOutput('enabled', 'false');
              console.log('â­ï¸ Trivy scan disabled (no auto-trivy topic)');
            }

  # 2ë‹¨ê³„: Trivy ë³´ì•ˆ ìŠ¤ìº” ì‹¤í–‰ (í† í”½ ìˆì„ ë•Œë§Œ)
  trivy-scan:
    needs: check-topic
    if: needs.check-topic.outputs.enabled == 'true'
    runs-on: ubuntu-latest
    # PRì—ì„œëŠ” ì‹¤íŒ¨í•´ë„ ë¨¸ì§€ ê°€ëŠ¥ (ê²½ê³ ë§Œ)
    continue-on-error: ${{ github.event_name == 'pull_request' }}
    
    steps:
      # ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v3
      
      # íŒŒì¼ì‹œìŠ¤í…œ ìŠ¤ìº” (ì˜ì¡´ì„± íŒŒì¼ ê²€ì‚¬)
      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH'
      
      # Docker ì´ë¯¸ì§€ ë¹Œë“œ (Dockerfile ìˆëŠ” ê²½ìš°)
      - name: Build Docker image
        if: hashFiles('Dockerfile') != ''
        run: |
          docker build -t scan-image:${{ github.sha }} .
      
      # Docker ì´ë¯¸ì§€ ìŠ¤ìº”
      - name: Run Trivy image scan
        if: hashFiles('Dockerfile') != ''
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          image-ref: 'scan-image:${{ github.sha }}'
          format: 'table'
          severity: 'CRITICAL,HIGH'
      
      # PRì— ì·¨ì•½ì  ë°œê²¬ ì‹œ ìë™ ì½”ë©˜íŠ¸
      - name: Comment on PR
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v6
        with:
          script: |
            const comment = `## âš ï¸ Security Vulnerabilities Detected
            
            Trivy security scan found vulnerabilities in this PR.
            
            **ğŸ“‹ Next Steps:**
            1. Check the Actions logs for detailed vulnerability information
            2. Review CRITICAL and HIGH severity issues
            3. Update vulnerable dependencies to fixed versions
            4. Push changes to re-run this scan
            
            **â„¹ï¸ Note:** This is a warning - you can still merge if necessary.
            
            **ğŸ” Common Fixes:**
            - Update package.json / requirements.txt to latest secure versions
            - Rebuild Docker image with updated base image
            - Check for security patches from package maintainers`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
  
  # 3ë‹¨ê³„: ë¹„í™œì„±í™” ì•Œë¦¼ (ì„ íƒì‚¬í•­)
  notify-disabled:
    needs: check-topic
    if: needs.check-topic.outputs.enabled == 'false' && github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    
    steps:
      - name: Notify that scan is disabled
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'â„¹ï¸ Trivy security scan is not enabled for this repository.\n\nTo enable: Add `auto-trivy` topic in repository Settings.'
            });
