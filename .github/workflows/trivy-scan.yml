# .github/workflows/trivy-scan.yml
# ì¤‘ì•™ Trivy ë³´ì•ˆ ìŠ¤ìº” ì›Œí¬í”Œë¡œìš°
# ì„œë¹„ìŠ¤ ë ˆí¬ì§€í† ë¦¬ì˜ 'secrets: inherit' ì„¤ì •ì„ í†µí•´ ë¹„ë°€ê°’ì„ ì§ì ‘ ì°¸ì¡°í•©ë‹ˆë‹¤.

name: Reusable Trivy Security Scan

on:
  workflow_call:
    inputs:
      force_run:
        required: false
        type: boolean
        default: false
      image_ref:
        required: false
        type: string
        default: ''
    # ì¬ì‚¬ìš© ì›Œí¬í”Œë¡œìš° í˜¸ì¶œ ì‹œ ì „ë‹¬ë°›ê±°ë‚˜ ìƒì†ë°›ì„ ë¹„ë°€ê°’ ì •ì˜
    secrets:
      NEXUS_USER:
        required: false
      NEXUS_PASSWORD:
        required: false

jobs:
  check-topic:
    runs-on: ubuntu-latest
    outputs:
      enabled: ${{ steps.check.outputs.enabled }}
    steps:
      - name: Check for auto-trivy topic or force_run
        id: check
        uses: actions/github-script@v6
        with:
          script: |
            // force_runì´ trueê±°ë‚˜ ì›ê²© ì´ë¯¸ì§€ ì£¼ì†Œê°€ ì…ë ¥ë˜ë©´ ì‹¤í–‰
            if (${{ inputs.force_run }} || "${{ inputs.image_ref }}" !== "") {
              core.setOutput('enabled', 'true');
              return;
            }
            const repo = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            const topics = repo.data.topics || [];
            core.setOutput('enabled', topics.includes('auto-trivy') ? 'true' : 'false');

  trivy-scan:
    needs: check-topic
    if: needs.check-topic.outputs.enabled == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1. ì´ë¯¸ì§€ ì£¼ì†Œì—ì„œ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë„ë©”ì¸ ì¶”ì¶œ (ìµìŠ¤í”„ë ˆì…˜ ì˜¤ë¥˜ í•´ê²°ìš©)
      - name: Extract Registry Host
        if: inputs.image_ref != ''
        id: get_reg
        run: |
          # ìŠ¬ë˜ì‹œ(/)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì²« ë²ˆì§¸ íŒŒíŠ¸ë¥¼ ì¶”ì¶œ (ì˜ˆ: registry-nexus.spectra.co.kr)
          DOMAIN=$(echo "${{ inputs.image_ref }}" | cut -d'/' -f1)
          echo "host=$DOMAIN" >> $GITHUB_OUTPUT

      # 2. ì‚¬ë‚´ Nexus ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸
      # ğŸ’¡ 'secrets' í‚¤ì›Œë“œê°€ if ì¡°ê±´ë¬¸ì—ì„œ ì—ëŸ¬ë¥¼ ìœ ë°œí•˜ë¯€ë¡œ inputs.image_ref ì—¬ë¶€ë§Œ ì²´í¬í•©ë‹ˆë‹¤.
      - name: Login to Nexus Registry
        if: inputs.image_ref != ''
        uses: docker/login-action@v3
        with:
          registry: ${{ steps.get_reg.outputs.host }}
          username: ${{ secrets.NEXUS_USER }}
          password: ${{ secrets.NEXUS_PASSWORD }}

      # 3. íŒŒì¼ ì‹œìŠ¤í…œ ìŠ¤ìº” (ì˜ì¡´ì„± ë¼ì´ë¸ŒëŸ¬ë¦¬)
      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          format: 'json'
          output: 'trivy-fs-results.json'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true

      # 4. ì´ë¯¸ì§€ ìŠ¤ìº” (ì›ê²© ë˜ëŠ” ë¡œì»¬ ë¹Œë“œ)
      - name: Run Trivy Image Scan
        uses: aquasecurity/trivy-action@master
        env:
          # Trivy ìŠ¤ìº” ì‹œ ì¸ì¦ì´ í•„ìš”í•œ ê²½ìš° ìƒì†ë°›ì€ ë¹„ë°€ê°’ ì‚¬ìš©
          TRIVY_USERNAME: ${{ secrets.NEXUS_USER }}
          TRIVY_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
        with:
          # image_refê°€ ìˆìœ¼ë©´ ì›ê²© ìŠ¤ìº”, ì—†ìœ¼ë©´ Dockerfile ì¡´ì¬ ì‹œ ë¡œì»¬ ë¹Œë“œ ìŠ¤ìº”
          image-ref: ${{ inputs.image_ref != '' && inputs.image_ref || (hashFiles('Dockerfile') != '' && format('local-image:{0}', github.sha) || '') }}
          scan-type: 'image'
          format: 'json'
          output: 'trivy-image-results.json'
          severity: 'CRITICAL,HIGH'
        if: inputs.image_ref != '' || hashFiles('Dockerfile') != ''

      # 5. ê²°ê³¼ ë¦¬í¬íŠ¸ ìƒì„± ë° í†µí•©
      - name: Generate HTML Reports
        if: always()
        run: |
          for f in trivy-*-results.json; do
            [ -f "$f" ] || continue
            docker run --rm -v ${{ github.workspace }}:/work aquasec/trivy:latest convert \
              --format template --template "@contrib/html.tpl" \
              --output "/work/${f%.json}.html" "/work/$f"
          done

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-security-report
          path: |
            trivy-*.json
            trivy-*.html
          retention-days: 7
